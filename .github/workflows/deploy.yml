name: ğŸš€ Deploy React-Vite Web-admin app

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-22.04

    steps:
      # 1ï¸âƒ£ Láº¥y source
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v3

      # 2ï¸âƒ£ Thiáº¿t láº­p Node.js
      - name: âš™ï¸ Set up Node.js environment
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      # 3ï¸âƒ£ CÃ i Ä‘áº·t dependencies
      - name: ğŸ“¦ Install dependencies (Yarn)
        run: yarn install --frozen-lockfile

      # 4ï¸âƒ£ Build project
      - name: ğŸ› ï¸ Build project with Vite (Yarn)
        run: |
          echo "ğŸ”¨ Building project..."
          yarn build
          echo "âœ… Build completed successfully."

      # 5ï¸âƒ£ Kiá»ƒm tra & chuáº©n bá»‹ thÆ° má»¥c trÃªn server
      - name: ğŸ§¹ Prepare server folder for deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          port: ${{ secrets.SERVER_PORT }}
          username: abp-server4
          key: ${{ secrets.SSH_PRIVATE_KEY }}

          timeout: 500s
          command_timeout: 20m
          debug: true

          script: |
            echo "ğŸ›°ï¸ Káº¿t ná»‘i SSH thÃ nh cÃ´ng!"
            echo "ğŸ“ Kiá»ƒm tra thÆ° má»¥c nginx..."
            ls -la /usr/share/nginx || echo "âš ï¸ ThÆ° má»¥c nginx chÆ°a tá»“n táº¡i!"
            echo "ğŸ§¹ XÃ³a thÆ° má»¥c cÅ©..."
            rm -rf /usr/share/nginx/web-admin || echo "âš ï¸ KhÃ´ng thá»ƒ xÃ³a (cÃ³ thá»ƒ chÆ°a tá»“n táº¡i)"
            echo "ğŸ“‚ Táº¡o thÆ° má»¥c má»›i..."
            mkdir -p /usr/share/nginx/web-admin
            echo "âœ… Server folder Ä‘Ã£ Ä‘Æ°á»£c chuáº©n bá»‹ xong."

      # 6ï¸âƒ£ Upload build files
      - name: ğŸš€ Upload dist to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          port: ${{ secrets.SERVER_PORT }}
          username: abp-server4
          key: ${{ secrets.SSH_PRIVATE_KEY }}

          source: 'dist/**'
          target: '/usr/share/nginx/web-admin'
          strip_components: 1
          timeout: 180s
          debug: true

      # 7ï¸âƒ£ ThÃ´ng bÃ¡o hoÃ n thÃ nh
      - name: âœ… Deployment Finished
        run: echo "ğŸ‰ Deployment completed successfully to ${{ secrets.SERVER_HOST }}"
